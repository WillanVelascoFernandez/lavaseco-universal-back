// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- SECURITY AND ACCESS ---

model Role {
  id          Int      @id @default(autoincrement())
  name        String   @unique // ADMIN, SUPERVISOR, OPERATOR
  permissions Json?    // e.g.: { "view_reports": true, "manage_users": true }
  isProtected Boolean  @default(false) @map("is_protected")
  
  users       User[]

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at")

  @@map("roles")
}

model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  password  String
  name      String?
  active    Boolean  @default(true) @map("is_active")
  
  // Role relation
  roleId    Int      @map("role_id")
  role      Role     @relation(fields: [roleId], references: [id])
  
  // User branch relation (Many-to-Many)
  branches  UserBranch[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  @@map("users")
}

// --- PHYSICAL STRUCTURE ---

model Branch {
  id          Int       @id @default(autoincrement())
  name        String    @unique
  address     String?
  phone       String?
  
  // Machines in this branch
  washers     Washer[]
  dryers      Dryer[]
  
  // Assigned users
  users       UserBranch[]

  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @default(now()) @updatedAt @map("updated_at")

  @@map("branches")
}

// Pivot table (Many-to-Many Bridge)
model UserBranch {
  userId      Int      @map("user_id")
  branchId    Int      @map("branch_id")
  
  user        User     @relation(fields: [userId], references: [id])
  branch      Branch   @relation(fields: [branchId], references: [id])

  @@id([userId, branchId])
  @@map("users_branches")
}

// --- MACHINES ---

model Washer {
  id          Int      @id @default(autoincrement())
  isEnabled   Boolean  @default(true) @map("is_enabled")
  
  // Branch relation
  branchId    Int      @map("branch_id")
  branch      Branch   @relation(fields: [branchId], references: [id])
  
  logs        WasherLog[]

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at")

  @@map("washers")
}

model Dryer {
  id          Int      @id @default(autoincrement())
  isEnabled   Boolean  @default(true) @map("is_enabled")
  
  // Branch relation
  branchId    Int      @map("branch_id")
  branch      Branch   @relation(fields: [branchId], references: [id])
  
  logs        DryerLog[]

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at")

  @@map("dryers")
}

// --- USAGE LOGS ---

model WasherLog {
  id          Int      @id @default(autoincrement())
  washerId    Int      @map("washer_id")
  washType    String   @map("wash_type")
  
  washer      Washer   @relation(fields: [washerId], references: [id])

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at")

  @@map("washers_logs")
}

model DryerLog {
  id          Int      @id @default(autoincrement())
  dryerId     Int      @map("dryer_id")
  dryType     String   @map("dry_type")
  
  dryer       Dryer    @relation(fields: [dryerId], references: [id])

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at")

  @@map("dryers_logs")
}
